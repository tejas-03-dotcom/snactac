<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Option Chain Data Fetcher</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <style>
        .oi-change-positive {
            color: green;
            font-weight: bold;
        }
        .oi-change-negative {
            color: red;
            font-weight: bold;
        }
        .atm-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .card {
            margin-bottom: 20px;
        }
        .badge {
            font-size: 0.9rem;
            padding: 5px 10px;
        }
        .metric-value {
            font-weight: bold;
        }
        .metric-label {
            min-width: 180px;
            display: inline-block;
        }
        .market-data-header {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .market-data-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .positive-change {
            color: #28a745;
        }
        .negative-change {
            color: #dc3545;
        }
        #current-time {
            color: #007bff;
        }
        .vix-high {
            color: #dc3545;
            font-weight: bold;
        }
        .vix-medium {
            color: #ffc107;
            font-weight: bold;
        }
        .vix-low {
            color: #28a745;
            font-weight: bold;
        }
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            z-index: 1000;
        }
        .toast-vix {
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
        }
        .toast-pcr {
            background-color: rgba(13, 110, 253, 0.1);
            border-left: 4px solid #0d6efd;
        }
        .toast-oi {
            background-color: rgba(25, 135, 84, 0.1);
            border-left: 4px solid #198754;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Alert container -->
        <div id="alertContainer" class="alert-toast"></div>

        <!-- Market Data Header -->
        <div class="row market-data-header">
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock me-2"></i>
                    <div>
                        <div class="text-muted small">Last Update</div>
                        <div id="current-time" class="market-data-value">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chart-line me-2"></i>
                    <div>
                        <div class="text-muted small">Market Price</div>
                        <div id="market-price" class="market-data-value">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bolt me-2"></i>
                    <div>
                        <div class="text-muted small">India VIX</div>
                        <div id="india-vix" class="market-data-value">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="d-flex align-items-center">
                    <i class="fas fa-percentage me-2"></i>
                    <div>
                        <div class="text-muted small">PCR (OI)</div>
                        <div id="pcr-oi" class="market-data-value">-</div>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="text-center">Option Chain Data Fetcher</h2>
        <p class="text-center text-muted">Top 10 Strike Prices (5 above & 5 below market price)</p>

        <form id="dataForm" class="mt-4">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="asset">Select Asset:</label>
                    <select class="form-control" id="asset" required>
                        <option value="NIFTY">NIFTY</option>
                        <option value="BANKNIFTY">BANKNIFTY</option>
                        <option value="FINNIFTY">FINNIFTY</option>
                        <option value="MIDCPNIFTY">MIDCPNIFTY</option>
                    </select>
                </div>

                <div class="form-group col-md-6">
                    <label for="expiry">Select Expiry Date:</label>
                    <input type="date" class="form-control" id="expiry" required>
                </div>
            </div>

            <div class="form-group text-center">
                <button type="submit" class="btn btn-primary mr-2">
                    <i class="fas fa-play"></i> Start Auto Fetch
                </button>
                <button type="button" class="btn btn-danger" id="stopFetch" disabled>
                    <i class="fas fa-stop"></i> Stop Auto Fetch
                </button>
            </div>
        </form>

        <hr>

        <div class="d-flex justify-content-center mb-3">
            <button class="btn btn-success mr-3" id="exportExcel" disabled>
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            <button class="btn btn-warning" id="exportPDF" disabled>
                <i class="fas fa-file-pdf"></i> Export to PDF
            </button>
        </div>

        <div id="loading" class="text-center mt-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <span class="ml-2">Fetching data every 15 seconds...</span>
            <div class="mt-2">
                <span id="lastUpdate" class="badge badge-secondary ml-2">Last Update: -</span>
            </div>
        </div>

        <div id="metricsContainer" class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Market Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><span class="metric-label">1a. Maximum Call OI:</span> <span id="maxCallOI" class="metric-value">-</span> @ <span id="maxCallOIStrike" class="metric-value">-</span></p>
                        <p><span class="metric-label">1b. Maximum Put OI:</span> <span id="maxPutOI" class="metric-value">-</span> @ <span id="maxPutOIStrike" class="metric-value">-</span></p>
                        <p><span class="metric-label">2A. Max Call OI % Change:</span> <span id="maxCallOIPctChange" class="metric-value">-</span></p>
                        <p><span class="metric-label">2B. Max Put OI % Change:</span> <span id="maxPutOIPctChange" class="metric-value">-</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><span class="metric-label">3A. PCR (OI):</span> <span id="pcrOI" class="metric-value">-</span></p>
                        <p><span class="metric-label">3B. PCR (OI) % Change:</span> <span id="pcrOIPctChange" class="metric-value">-</span></p>
                        <p><span class="metric-label">4A. India VIX:</span> <span id="indiaVIX" class="metric-value">-</span></p>
                        <p><span class="metric-label">4B. India VIX % Change:</span> <span id="indiaVIXPctChange" class="metric-value">-</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive mt-3">
            <table class="table table-bordered table-hover table-sm">
                <thead class="thead-dark">
                    <tr>
                        <th>Strike Price</th>
                        <th>Market Price</th>
                        <th>PCR (Put OI/Call OI)</th>
                        <th>Call LTP</th>
                        <th>Call OI</th>
                        <th>Call ΔOI</th>
                        <th>Call OI%</th>
                        <th>Put LTP</th>
                        <th>Put OI</th>
                        <th>Put ΔOI</th>
                        <th>Put OI%</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <canvas id="oiTrendChart" height="250"></canvas>
            </div>
            <div class="col-md-6">
                <canvas id="priceTrendChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let optionData = [];
        let allIntervalData = [];
        let currentSessionData = [];
        let intervalId = null;
        let oiTrendChart = null;
        let priceTrendChart = null;
        let sessionStartTime = null;
        let currentAsset = '';
        let currentExpiry = '';
        let previousMetrics = null;
        let previousIndiaVIX = null;
        let nseCookies = null;
        let lastUpdateTime = null;

        // VIX Thresholds
        const VIX_THRESHOLDS = {
            HIGH: 20,    // Above this is considered high volatility
            MEDIUM: 15   // Between 15-20 is medium volatility
        };

        // DOM elements
        const dataForm = document.getElementById("dataForm");
        const stopFetchBtn = document.getElementById("stopFetch");
        const exportExcelBtn = document.getElementById("exportExcel");
        const exportPDFBtn = document.getElementById("exportPDF");
        const loadingDiv = document.getElementById("loading");
        const lastUpdateBadge = document.getElementById("lastUpdate");
        const dataTableBody = document.getElementById("dataTableBody");
        const currentTimeDisplay = document.getElementById("current-time");
        const marketPriceDisplay = document.getElementById("market-price");
        const indiaVIXDisplay = document.getElementById("india-vix");
        const pcrOIDisplay = document.getElementById("pcr-oi");
        const alertContainer = document.getElementById("alertContainer");


        // Initialize the expiry date to next Thursday
        function initializeExpiryDate() {
            const today = new Date();
            let expiryDate = new Date(today);

            // Find next Thursday (NIFTY weekly expiry)
            expiryDate.setDate(today.getDate() + ((4 - today.getDay() + 7) % 7));
            if (expiryDate <= today) {
                expiryDate.setDate(expiryDate.getDate() + 7);
            }

            // Format as YYYY-MM-DD for date input
            const formattedDate = expiryDate.toISOString().split('T')[0];
            document.getElementById("expiry").value = formattedDate;
        }

        // Alert Manager Class
        class AlertManager {
            constructor() {
                this.previousVIX = null;
                this.alertsTriggered = new Set();
            }

            checkThresholds(currentData, metrics) {
                const alerts = [];
                const now = new Date();

                // 1. VIX Alerts
                if (metrics.indiaVIX) {
                    // Check VIX level thresholds
                    if (metrics.indiaVIX > VIX_THRESHOLDS.HIGH) {
                        alerts.push({
                            type: 'vix',
                            title: 'High Volatility Warning',
                            message: `VIX is high at ${metrics.indiaVIX.toFixed(2)} (Above ${VIX_THRESHOLDS.HIGH})`,
                            timestamp: now
                        });
                    } else if (metrics.indiaVIX > VIX_THRESHOLDS.MEDIUM) {
                        alerts.push({
                            type: 'vix',
                            title: 'Medium Volatility',
                            message: `VIX is elevated at ${metrics.indiaVIX.toFixed(2)} (Above ${VIX_THRESHOLDS.MEDIUM})`,
                            timestamp: now
                        });
                    }

                    // Large % change alert
                    if (this.previousVIX && Math.abs(metrics.indiaVIXPctChange) > 10) {
                        alerts.push({
                            type: 'vix',
                            title: 'VIX Rapid Move',
                            message: `VIX changed ${metrics.indiaVIXPctChange > 0 ? '+' : ''}${metrics.indiaVIXPctChange.toFixed(2)}% in 2 mins`,
                            timestamp: now
                        });
                    }
                    this.previousVIX = metrics.indiaVIX;
                }

                // 2. PCR Alerts
                if (metrics.pcrOI > 1.5) {
                    alerts.push({
                        type: 'pcr',
                        title: 'High Put/Call Ratio',
                        message: `PCR(OI) ${metrics.pcrOI.toFixed(2)} > 1.5 (Bearish sentiment)`,
                        timestamp: now
                    });
                } else if (metrics.pcrOI < 0.7) {
                    alerts.push({
                        type: 'pcr',
                        title: 'Low Put/Call Ratio',
                        message: `PCR(OI) ${metrics.pcrOI.toFixed(2)} < 0.7 (Bullish sentiment)`,
                        timestamp: now
                    });
                }

                // 3. Open Interest Alerts
                currentData.forEach(item => {
                    // Significant Call OI changes (>30%)
                    if (item.call.OI > 10000 && Math.abs(item.call.OIPctChange) > 30) {
                        alerts.push({
                            type: 'oi',
                            title: `Large Call OI Change at ${item.strikePrice}`,
                            message: `${item.call.OIPctChange > 0 ? '+' : ''}${item.call.OIPctChange.toFixed(2)}% (${formatChange(item.call.OIChange)})`,
                            timestamp: now,
                            strike: item.strikePrice
                        });
                    }

                    // Significant Put OI changes (>30%)
                    if (item.put.OI > 10000 && Math.abs(item.put.OIPctChange) > 30) {
                        alerts.push({
                            type: 'oi',
                            title: `Large Put OI Change at ${item.strikePrice}`,
                            message: `${item.put.OIPctChange > 0 ? '+' : ''}${item.put.OIPctChange.toFixed(2)}% (${formatChange(item.put.OIChange)})`,
                            timestamp: now,
                            strike: item.strikePrice
                        });
                    }
                });

                return alerts;
            }

            showAlert(alert) {
                const alertId = `${alert.type}-${alert.timestamp.getTime()}-${alert.strike || ''}`;
                if (this.alertsTriggered.has(alertId)) return;

                const toast = document.createElement('div');
                toast.className = `toast fade show alert-toast toast-${alert.type}`;
                toast.role = 'alert';
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                toast.innerHTML = `
                    <div class="toast-header">
                        <strong class="mr-auto">${alert.title}</strong>
                        <small>${alert.timestamp.toLocaleTimeString()}</small>
                        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">${alert.message}</div>
                `;

                alertContainer.appendChild(toast);
                this.alertsTriggered.add(alertId);

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 150);
                }, 10000);
            }
        }

        const alertManager = new AlertManager();

        // Initialize expiry date
        initializeExpiryDate();

        // Fetch NSE cookies (required for API access)
        async function fetchNSECookies() {
            try {
                const response = await axios.get('https://www.nseindia.com', {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                        'Accept-Language': 'en-US,en;q=0.9'
                    }
                });
                nseCookies = response.headers['set-cookie'].join('; ');
                return nseCookies;
            } catch (error) {
                console.error("Error fetching NSE cookies:", error);
                return null;
            }
        }

        // Fetch real India VIX data from NSE
        async function fetchIndiaVIX() {
            try {
                if (!nseCookies) {
                    await fetchNSECookies();
                    if (!nseCookies) {
                        throw new Error("Failed to get NSE cookies");
                    }
                }

                const response = await axios.get('https://www.nseindia.com/api/option-chain-indices?symbol=INDIAVIX', {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'Cookie': nseCookies
                    }
                });

                const vixValue = parseFloat(response.data.records.underlyingValue);

                // Set VIX display with appropriate class based on threshold
                indiaVIXDisplay.textContent = vixValue.toFixed(2);
                indiaVIXDisplay.className = 'market-data-value ' +
                    (vixValue > VIX_THRESHOLDS.HIGH ? 'vix-high' :
                     vixValue > VIX_THRESHOLDS.MEDIUM ? 'vix-medium' : 'vix-low');

                return vixValue;
            } catch (error) {
                console.error("Error fetching India VIX from NSE:", error);
                // Fallback to Yahoo Finance if NSE fails
                try {
                    const yahooResponse = await axios.get('https://query1.finance.yahoo.com/v8/finance/chart/%5EINDIAVIX');
                    const vixValue = parseFloat(yahooResponse.data.chart.result[0].meta.regularMarketPrice);
                    indiaVIXDisplay.textContent = vixValue.toFixed(2);
                    indiaVIXDisplay.className = 'market-data-value ' +
                        (vixValue > VIX_THRESHOLDS.HIGH ? 'vix-high' :
                         vixValue > VIX_THRESHOLDS.MEDIUM ? 'vix-medium' : 'vix-low');
                    return vixValue;
                } catch (yahooError) {
                    console.error("Error fetching India VIX from Yahoo:", yahooError);
                    indiaVIXDisplay.textContent = 'Error';
                    return null;
                }
            }
        }

        // Fetch data from API
        async function fetchData(asset, expiry) {
            try {
                const response = await axios.get(`http://localhost:3000/api/option-chain?symbol=${asset}&expiry=${expiry}`);
                return response.data;
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Failed to fetch data. Please check the API.");
                return [];
            }
        }

        // Filter to get top 5 strikes above and below market price
        function filterTopStrikes(data, marketPrice) {
            if (!data || data.length === 0) return [];

            // Sort all strike prices
            const sortedStrikes = [...data].sort((a, b) => a.strikePrice - b.strikePrice);

            // Find index where strikePrice >= marketPrice
            let marketIndex = sortedStrikes.findIndex(item => item.strikePrice >= marketPrice);
            if (marketIndex === -1) marketIndex = sortedStrikes.length;

            // Get 5 strikes below and 5 above market price
            const startIdx = Math.max(marketIndex - 5, 0);
            const endIdx = Math.min(marketIndex + 4, sortedStrikes.length - 1);

            return sortedStrikes.slice(startIdx, endIdx + 1);
        }

        // Calculate PCR for each strike price
        function calculatePCR(data) {
            return data.map(item => {
                const pcr = item.call.OI > 0 ? (item.put.OI / item.call.OI) : 0;
                return {
                    ...item,
                    pcr: pcr.toFixed(2)
                };
            });
        }

        // Calculate various metrics
        function calculateMetrics(data, previousMetrics, indiaVIX, previousIndiaVIX) {
            if (!data || data.length === 0) {
                return {
                    maxCallOI: 0,
                    maxCallOIStrike: 0,
                    maxCallOIPctChange: 0,
                    maxPutOI: 0,
                    maxPutOIStrike: 0,
                    maxPutOIPctChange: 0,
                    pcrOI: 0,
                    pcrOIPctChange: 0,
                    indiaVIX: indiaVIX || 0,
                    indiaVIXPctChange: 0
                };
            }

            // Calculate total OIs
            const totalCallOI = data.reduce((sum, item) => sum + item.call.OI, 0);
            const totalPutOI = data.reduce((sum, item) => sum + item.put.OI, 0);

            // Calculate PCR (OI)
            const pcrOI = totalCallOI > 0 ? (totalPutOI / totalCallOI) : 0;

            // Calculate PCR (OI) % change
            let pcrOIPctChange = 0;
            if (previousMetrics && previousMetrics.pcrOI > 0) {
                pcrOIPctChange = ((pcrOI - previousMetrics.pcrOI) / previousMetrics.pcrOI) * 100;
            }

            // Find maximum OI values
            let maxCallOI = 0;
            let maxCallOIStrike = 0;
            let maxCallOIPctChange = 0;

            let maxPutOI = 0;
            let maxPutOIStrike = 0;
            let maxPutOIPctChange = 0;

            data.forEach(item => {
                // For calls
                if (item.call.OI > maxCallOI) {
                    maxCallOI = item.call.OI;
                    maxCallOIStrike = item.strikePrice;
                    maxCallOIPctChange = item.call.OIPctChange || 0;
                }

                // For puts
                if (item.put.OI > maxPutOI) {
                    maxPutOI = item.put.OI;
                    maxPutOIStrike = item.strikePrice;
                    maxPutOIPctChange = item.put.OIPctChange || 0;
                }
            });

            // Calculate India VIX % change
            let indiaVIXPctChange = 0;
            if (previousIndiaVIX && previousIndiaVIX > 0 && indiaVIX) {
                indiaVIXPctChange = ((indiaVIX - previousIndiaVIX) / previousIndiaVIX * 100);
            }

            return {
                maxCallOI,
                maxCallOIStrike,
                maxCallOIPctChange,
                maxPutOI,
                maxPutOIStrike,
                maxPutOIPctChange,
                pcrOI,
                pcrOIPctChange,
                indiaVIX: indiaVIX || 0,
                indiaVIXPctChange
            };
        }

        // Render data in the table
        function renderTable(data, marketPrice) {
            if (!data || data.length === 0) {
                dataTableBody.innerHTML = '<tr><td colspan="11" class="text-center">No data available</td></tr>';
                return;
            }

            let tableHTML = '';

            data.forEach(item => {
                const isATM = item.strikePrice === marketPrice;
                const rowClass = isATM ? 'atm-row' : '';
                const pcr = item.call.OI > 0 ? (item.put.OI / item.call.OI).toFixed(2) : 'N/A';

                tableHTML += `<tr class="${rowClass}">
                    <td>${item.strikePrice}</td>
                    <td>${marketPrice.toFixed(2)}</td>
                    <td>${pcr}</td>
                    <td>${item.call.LTP.toFixed(2)}</td>
                    <td>${item.call.OI.toLocaleString()}</td>
                    <td class="${getChangeClass(item.call.OIChange)}">${formatChange(item.call.OIChange)}</td>
                    <td class="${getChangeClass(item.call.OIPctChange)}">${formatPercentage(item.call.OIPctChange)}</td>
                    <td>${item.put.LTP.toFixed(2)}</td>
                    <td>${item.put.OI.toLocaleString()}</td>
                    <td class="${getChangeClass(item.put.OIChange)}">${formatChange(item.put.OIChange)}</td>
                    <td class="${getChangeClass(item.put.OIPctChange)}">${formatPercentage(item.put.OIPctChange)}</td>
                </tr>`;
            });

            dataTableBody.innerHTML = tableHTML;
        }

        // Helper function to format change values
        function formatChange(value) {
            if (value === undefined || value === null) return '-';
            if (value > 0) return `+${value.toLocaleString()}`;
            if (value < 0) return `${value.toLocaleString()}`;
            return '0';
        }

        // Helper function to format percentage values
        function formatPercentage(value) {
            if (value === undefined || value === null) return '-';
            if (value > 0) return `+${value.toFixed(2)}%`;
            if (value < 0) return `${value.toFixed(2)}%`;
            return '0%';
        }

        // Helper function to get CSS class for change values
        function getChangeClass(value) {
            if (value > 0) return 'oi-change-positive';
            if (value < 0) return 'oi-change-negative';
            return '';
        }

        // Calculate OI changes between current and previous data
        function calculateOIChanges(currentData, previousData) {
            if (!previousData) {
                return currentData.map(item => ({
                    ...item,
                    call: {
                        ...item.call,
                        OIChange: 0,
                        OIPctChange: 0
                    },
                    put: {
                        ...item.put,
                        OIChange: 0,
                        OIPctChange: 0
                    }
                }));
            }

            return currentData.map(item => {
                const prevItem = previousData.find(prev => prev.strikePrice === item.strikePrice);
                const prevCallOI = prevItem?.call.OI || 0;
                const prevPutOI = prevItem?.put.OI || 0;

                // Calculate OI change percentage
                const callOIPctChange = prevCallOI > 0 ?
                    ((item.call.OI - prevCallOI) / prevCallOI * 100) : 0;
                const putOIPctChange = prevPutOI > 0 ?
                    ((item.put.OI - prevPutOI) / prevPutOI * 100) : 0;

                return {
                    ...item,
                    call: {
                        ...item.call,
                        OIChange: item.call.OI - prevCallOI,
                        OIPctChange: callOIPctChange
                    },
                    put: {
                        ...item.put,
                        OIChange: item.put.OI - prevPutOI,
                        OIPctChange: putOIPctChange
                    }
                };
            });
        }

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            lastUpdateTime = now;
            currentTimeDisplay.textContent = now.toLocaleTimeString();
            lastUpdateBadge.textContent = `Last Update: ${now.toLocaleTimeString()}`;
        }

        // Update metrics UI
        function updateMetricsUI(metrics, marketPrice) {
            // Update market data header
            marketPriceDisplay.textContent = marketPrice.toFixed(2);
            pcrOIDisplay.textContent = metrics.pcrOI.toFixed(2);

            // Update metrics container
            document.getElementById('maxCallOI').textContent = metrics.maxCallOI.toLocaleString();
            document.getElementById('maxCallOIStrike').textContent = metrics.maxCallOIStrike;
            document.getElementById('maxCallOIPctChange').textContent = formatPercentage(metrics.maxCallOIPctChange);
            document.getElementById('maxPutOI').textContent = metrics.maxPutOI.toLocaleString();
            document.getElementById('maxPutOIStrike').textContent = metrics.maxPutOIStrike;
            document.getElementById('maxPutOIPctChange').textContent = formatPercentage(metrics.maxPutOIPctChange);
            document.getElementById('pcrOI').textContent = metrics.pcrOI.toFixed(2);
            document.getElementById('pcrOIPctChange').textContent = formatPercentage(metrics.pcrOIPctChange);
            document.getElementById('indiaVIX').textContent = metrics.indiaVIX ? metrics.indiaVIX.toFixed(2) : '-';
            document.getElementById('indiaVIXPctChange').textContent = formatPercentage(metrics.indiaVIXPctChange);

            // Set color for changes
            document.getElementById('maxCallOIPctChange').className = 'metric-value ' + getChangeClass(metrics.maxCallOIPctChange);
            document.getElementById('maxPutOIPctChange').className = 'metric-value ' + getChangeClass(metrics.maxPutOIPctChange);
            document.getElementById('pcrOIPctChange').className = 'metric-value ' + getChangeClass(metrics.pcrOIPctChange);
            document.getElementById('indiaVIXPctChange').className = 'metric-value ' + getChangeClass(metrics.indiaVIXPctChange);
        }

        // Initialize/update OI trend chart
        function updateOITrendChart() {
            const ctx = document.getElementById('oiTrendChart').getContext('2d');

            if (oiTrendChart) {
                oiTrendChart.destroy();
            }

            if (currentSessionData.length < 2) {
                return;
            }

            const labels = currentSessionData.map(interval =>
                interval.timestamp.toLocaleTimeString()
            );

            const callOIData = currentSessionData.map(interval =>
                interval.data.reduce((sum, item) => sum + item.call.OI, 0)
            );

            const putOIData = currentSessionData.map(interval =>
                interval.data.reduce((sum, item) => sum + item.put.OI, 0)
            );

            oiTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Call OI',
                            data: callOIData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Total Put OI',
                            data: putOIData,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Open Interest Trend'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Open Interest'
                            }
                        }
                    }
                }
            });
        }

        // Initialize/update Price trend chart
        function updatePriceTrendChart() {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');

            if (priceTrendChart) {
                priceTrendChart.destroy();
            }

            if (currentSessionData.length < 2) {
                return;
            }

            const labels = currentSessionData.map(interval =>
                interval.timestamp.toLocaleTimeString()
            );

            const marketPrices = currentSessionData.map(interval => interval.marketPrice);
            const avgCallPrices = currentSessionData.map(interval =>
                interval.data.reduce((sum, item) => sum + item.call.LTP, 0) / interval.data.length
            );
            const avgPutPrices = currentSessionData.map(interval =>
                interval.data.reduce((sum, item) => sum + item.put.LTP, 0) / interval.data.length
            );

            priceTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Market Price',
                            data: marketPrices,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Avg Call Price',
                            data: avgCallPrices,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Avg Put Price',
                            data: avgPutPrices,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Price Trend'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        }
                    }
                }
            });
        }

        // Main function to fetch and process data
        async function autoFetchData() {
            const asset = document.getElementById("asset").value;
            const expiry = document.getElementById("expiry").value;

            if (!asset || !expiry) {
                alert("Please select an asset and expiry date.");
                return;
            }

            // Update current asset and expiry if changed
            if (asset !== currentAsset || expiry !== currentExpiry) {
                currentAsset = asset;
                currentExpiry = expiry;
                currentSessionData = [];
                sessionStartTime = new Date();
                previousMetrics = null;
                previousIndiaVIX = null;
            }

            // Start new session if needed
            if (!sessionStartTime) {
                sessionStartTime = new Date();
            }

            loadingDiv.style.display = "block";

            try {
                // Fetch option chain data and India VIX in parallel
                const [newData, indiaVIX] = await Promise.all([
                    fetchData(asset, expiry),
                    fetchIndiaVIX()
                ]);

                if (newData.length === 0) {
                    dataTableBody.innerHTML = '<tr><td colspan="11" class="text-center">No data available</td></tr>';
                    return;
                }

                const marketPrice = newData[0]?.marketPrice || 0;
                const filteredData = filterTopStrikes(newData, marketPrice);

                // Calculate OI changes
                const previousData = currentSessionData.length > 0
                    ? currentSessionData[currentSessionData.length - 1].data
                    : null;
                const dataWithChanges = calculateOIChanges(filteredData, previousData);

                const timestamp = new Date();
                const intervalData = {
                    timestamp,
                    marketPrice,
                    data: dataWithChanges
                };

                // Store data
                currentSessionData.push(intervalData);
                allIntervalData.push(intervalData);

                // Calculate metrics
                const currentMetrics = calculateMetrics(dataWithChanges, previousMetrics, indiaVIX, previousIndiaVIX);

                // Check for alerts
                const alerts = alertManager.checkThresholds(dataWithChanges, currentMetrics);
                alerts.forEach(alert => alertManager.showAlert(alert));

                // Update UI
                renderTable(dataWithChanges, marketPrice);
                updateMetricsUI(currentMetrics, marketPrice);
                updateOITrendChart();
                updatePriceTrendChart();
                updateLastUpdateTime();

                exportExcelBtn.disabled = false;
                exportPDFBtn.disabled = false;

                // Store current metrics and India VIX for next comparison
                previousMetrics = currentMetrics;
                previousIndiaVIX = indiaVIX;
            } catch (error) {
                console.error("Error in autoFetchData:", error);
            } finally {
                loadingDiv.style.display = "none";
            }
        }

        // Export data to Excel
        function exportToExcel() {
            if (currentSessionData.length === 0) {
                alert("No data to export!");
                return;
            }

            const wb = XLSX.utils.book_new();
            const asset = document.getElementById("asset").value;
            const expiry = document.getElementById("expiry").value;

            // Prepare data for export
            const exportData = [];

            currentSessionData.forEach(interval => {
                interval.data.forEach(item => {
                    exportData.push({
                        "Timestamp": interval.timestamp.toLocaleString(),
                        "Strike Price": item.strikePrice,
                        "Market Price": interval.marketPrice,
                        "PCR": item.call.OI > 0 ? (item.put.OI / item.call.OI).toFixed(2) : 0,
                        "Call LTP": item.call.LTP,
                        "Call OI": item.call.OI,
                        "Call ΔOI": item.call.OIChange,
                        "Call OI%": item.call.OIPctChange,
                        "Put LTP": item.put.LTP,
                        "Put OI": item.put.OI,
                        "Put ΔOI": item.put.OIChange,
                        "Put OI%": item.put.OIPctChange,
                        "VIX": interval.metrics?.indiaVIX || 0,
                        "VIX % Change": interval.metrics?.indiaVIXPctChange || 0
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, "OptionChainData");

            // Add metrics sheet
            const metricsData = currentSessionData.map(interval => {
                const metrics = calculateMetrics(interval.data);
                return {
                    "Timestamp": interval.timestamp.toLocaleString(),
                    "Market Price": interval.marketPrice,
                    "Max Call OI": metrics.maxCallOI,
                    "Max Call Strike": metrics.maxCallOIStrike,
                    "Max Call OI %": metrics.maxCallOIPctChange,
                    "Max Put OI": metrics.maxPutOI,
                    "Max Put Strike": metrics.maxPutOIStrike,
                    "Max Put OI %": metrics.maxPutOIPctChange,
                    "PCR (OI)": metrics.pcrOI,
                    "PCR % Change": metrics.pcrOIPctChange,
                    "India VIX": metrics.indiaVIX,
                    "India VIX % Change": metrics.indiaVIXPctChange
                };
            });

            const metricsWs = XLSX.utils.json_to_sheet(metricsData);
            XLSX.utils.book_append_sheet(wb, metricsWs, "Metrics");

            XLSX.writeFile(wb, `${asset}_${expiry}_OptionChain_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // Export data to PDF
        function exportToPDF() {
            if (currentSessionData.length === 0) {
                alert("No data to export!");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const asset = document.getElementById("asset").value;
            const expiry = document.getElementById("expiry").value;

            // Add title
            doc.setFontSize(16);
            doc.text(`${asset} Option Chain Data - ${expiry}`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);

            // Prepare data for export
            const exportData = [];

            currentSessionData.forEach(interval => {
                interval.data.forEach(item => {
                    const pcr = item.call.OI > 0 ? (item.put.OI / item.call.OI).toFixed(2) : 'N/A';
                    exportData.push([
                        interval.timestamp.toLocaleTimeString(),
                        item.strikePrice,
                        interval.marketPrice.toFixed(2),
                        pcr,
                        item.call.LTP.toFixed(2),
                        item.call.OI.toLocaleString(),
                        formatChange(item.call.OIChange),
                        formatPercentage(item.call.OIPctChange),
                        item.put.LTP.toFixed(2),
                        item.put.OI.toLocaleString(),
                        formatChange(item.put.OIChange),
                        formatPercentage(item.put.OIPctChange)
                    ]);
                });
            });

            // Add table
            doc.autoTable({
                head: [
                    ['Time', 'Strike', 'Market', 'PCR', 'Call LTP', 'Call OI', 'Call ΔOI', 'Call OI%', 'Put LTP', 'Put OI', 'Put ΔOI', 'Put OI%']
                ],
                body: exportData,
                startY: 30,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [44, 62, 80]
                },
                columnStyles: {
                    0: { cellWidth: 15 },
                    1: { cellWidth: 15 },
                    2: { cellWidth: 15 },
                    3: { cellWidth: 10 },
                    4: { cellWidth: 15 },
                    5: { cellWidth: 15 },
                    6: { cellWidth: 15 },
                    7: { cellWidth: 15 },
                    8: { cellWidth: 15 },
                    9: { cellWidth: 15 },
                    10: { cellWidth: 15 },
                    11: { cellWidth: 15 }
                },
                didDrawPage: function (data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(150);
                    doc.text(
                        `Page ${data.pageCount}`,
                        doc.internal.pageSize.getWidth() / 2,
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                }
            });

            // Add new page for metrics
            doc.addPage();
            doc.setFontSize(16);
            doc.text('Market Metrics', 14, 15);

            const metricsData = currentSessionData.map(interval => {
                const metrics = calculateMetrics(interval.data);
                return [
                    interval.timestamp.toLocaleTimeString(),
                    interval.marketPrice.toFixed(2),
                    metrics.maxCallOI.toLocaleString(),
                    metrics.maxCallOIStrike,
                    formatPercentage(metrics.maxCallOIPctChange),
                    metrics.maxPutOI.toLocaleString(),
                    metrics.maxPutOIStrike,
                    formatPercentage(metrics.maxPutOIPctChange),
                    metrics.pcrOI.toFixed(2),
                    formatPercentage(metrics.pcrOIPctChange),
                    metrics.indiaVIX.toFixed(2),
                    formatPercentage(metrics.indiaVIXPctChange)
                ];
            });

            doc.autoTable({
                head: [
                    ['Time', 'Market', 'Max Call OI', 'Strike', 'Call OI%', 'Max Put OI', 'Strike', 'Put OI%', 'PCR', 'PCR % Chg', 'India VIX', 'VIX % Chg']
                ],
                body: metricsData,
                startY: 25,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [44, 62, 80]
                }
            });

            doc.save(`${asset}_${expiry}_OptionChain_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        // Event listeners
        dataForm.addEventListener("submit", function(e) {
            e.preventDefault();

            // Clear any existing interval
            if (intervalId) {
                clearInterval(intervalId);
            }

            // Start new interval (1 minutes)
            autoFetchData();
            intervalId = setInterval(autoFetchData, 1* 10 * 1000);

            stopFetchBtn.disabled = false;
            exportExcelBtn.disabled = true;
            exportPDFBtn.disabled = true;
        });

        stopFetchBtn.addEventListener("click", function() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
                loadingDiv.style.display = "none";
                stopFetchBtn.disabled = true;
            }
        });

        exportExcelBtn.addEventListener("click", exportToExcel);
        exportPDFBtn.addEventListener("click", exportToPDF);
    </script>
</body>
</html>
